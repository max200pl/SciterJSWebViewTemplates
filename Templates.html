<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Template</title>

    <style>
      html,
      body {
        font-family: system-ui;
        background: transparent;
        color: black;
        margin: 0;
        padding: 0;
        overflow: hidden; /* important: no scrollbars from tiny rounding */
      }

      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        color: black;
        width: 450px;
        min-height: 420px;
        background: white;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-sizing: border-box; /* important: width includes border/padding */
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      button {
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: #efefef;
        font-size: 12px;
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #10b04a;
      }

      .title {
        margin: 0;
        color: black;
      }

      .subtitle {
        margin: 0;
        font-size: 14px;
        color: #333;
      }

      /* Optional debug area — fixed height so it DOES NOT change card size */
      pre {
        background: #f6f6f6;
        padding: 10px;
        border-radius: 10px;
        white-space: pre-wrap;
        font-size: 12px;
        overflow: auto;
        box-sizing: border-box;

        flex: none;
        max-height: 120px; /* keep stable height */
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h3 class="title" id="header"></h3>

      <div class="badge">
        <span class="dot" id="dot"></span>
        <span id="counterLabel"></span>
        <b id="counter">0</b>
      </div>

      <p class="subtitle" id="subtitle"></p>

      <div class="row">
        <button id="switchLang">Switch language</button>
        <button id="applyPayload">Apply payload</button>
      </div>

      <div class="row">
        <button id="closeWebview">Close WebView</button>
        <button id="cta">CTA</button>
      </div>

      <!-- You can remove this node; logic will still work -->
      <pre id="out"></pre>
    </div>

    <script>
      const out = document.getElementById("out");
      const headerEl = document.getElementById("header");
      const subtitleEl = document.getElementById("subtitle");
      const counterEl = document.getElementById("counter");
      const counterLabelEl = document.getElementById("counterLabel");
      const dotEl = document.getElementById("dot");

      // local fallback i18n (used when Sciter does NOT send i18n)
      const i18n = {
        en: {
          title: "Program removed: {programName}",
          subtitle: "Leftover files: {count}",
          counter: "Live counter",
          switch: "Switch language",
        },
        uk: {
          title: "Програму видалено: {programName}",
          subtitle: "Залишкових файлів: {count}",
          counter: "Лічильник",
          switch: "Змінити мову",
        },
        ru: {
          title: "Программа удалена: {programName}",
          subtitle: "Остаточных файлов: {count}",
          counter: "Счётчик",
          switch: "Сменить язык",
        },
      };

      const state = {
        lang: "en",
        ticks: 0,
        payload: { programName: "WinZip", count: 12 },
      };

      // safe log: works even if <pre id="out"> is removed
      function log(msg) {
        if (out) {
          // keep last ~120 lines to avoid endless growth
          const next = (out.textContent ? out.textContent + "\\n" : "") + msg;
          const lines = next.split("\\n");
          out.textContent =
            lines.length > 120
              ? lines.slice(lines.length - 120).join("\\n")
              : next;
        }
        console.log(msg);
      }

      // ✅ merge i18n from Sciter (partial override supported)
      function mergeI18n(hostI18n) {
        if (!hostI18n || typeof hostI18n !== "object") return false;

        for (const [lang, dict] of Object.entries(hostI18n)) {
          if (!dict || typeof dict !== "object") continue;
          i18n[lang] = { ...(i18n[lang] || {}), ...dict };
        }
        return true;
      }

      const t = (key) => i18n[state.lang]?.[key] ?? i18n.en[key] ?? key;

      const fmt = (str) =>
        String(str).replace(/\\{(\\w+)\\}/g, (_, k) => state.payload[k] ?? "");

      // ==== size reporting (stable) ====
      let __measureScheduled = false;
      let __lastSizeKey = "";

      function reportCardSize() {
        const card = document.querySelector(".card");
        if (!card) return;

        // offsetWidth/offsetHeight are stable (no fractional rounding issues)
        const width = card.offsetWidth;
        const height = card.offsetHeight;

        const key = width + "x" + height;
        if (key === __lastSizeKey) return;
        __lastSizeKey = key;

        safeCall("template:onSize", { width, height });
      }

      function requestMeasure() {
        if (__measureScheduled) return;
        __measureScheduled = true;

        // one measure per tick, after DOM updates are applied
        setTimeout(() => {
          __measureScheduled = false;
          reportCardSize();
        }, 0);
      }

      function render() {
        headerEl.textContent = fmt(t("title"));
        subtitleEl.textContent = fmt(t("subtitle"));
        counterLabelEl.textContent = t("counter");
        document.getElementById("switchLang").textContent = t("switch");

        dotEl.style.background =
          state.payload.count > 20 ? "#ff3b30" : "#10b04a";

        log(
          "render -> lang=" +
            state.lang +
            " payload=" +
            JSON.stringify(state.payload),
        );

        requestMeasure();
      }

      // counter = obvious dynamic proof
      setInterval(() => {
        state.ticks++;
        counterEl.textContent = state.ticks;
        dotEl.style.opacity = state.ticks % 2 ? "0.5" : "1";
      }, 1000);

      function switchLang() {
        const order = ["en", "uk", "ru"];
        const idx = order.indexOf(state.lang);
        state.lang = order[(idx + 1) % order.length];
        render();
      }

      function applyPayload(p) {
        state.payload = { ...state.payload, ...p };
        render();
      }

      async function safeCall(method, payload) {
        if (!window.jsBridgeCall) {
          log("❌ jsBridgeCall not found");
          return;
        }
        const res = await window.jsBridgeCall(method, payload);
        log("➡️ " + method + " " + JSON.stringify(payload));
        log("⬅️ " + JSON.stringify(res));
      }

      window.addEventListener("load", () => {
        safeCall("template:onReady", { lang: state.lang, ts: Date.now() });
        render();

        // resize events can happen after host window move/resize
        window.addEventListener("resize", requestMeasure);
      });

      document.getElementById("switchLang").onclick = () => switchLang();

      document.getElementById("applyPayload").onclick = () =>
        applyPayload({ programName: "Adobe Reader", count: 27 });

      document.getElementById("closeWebview").onclick = () =>
        safeCall("template:onAction", { action: "close_webview" });

      document.getElementById("cta").onclick = () =>
        safeCall("template:onAction", {
          action: "cta_click",
          lang: state.lang,
        });

      // ===== Sciter -> WebView =====
      window.__fromSciter = function (msg) {
        // keep this log safe even if out is missing
        log("⬅️ from Sciter: " + JSON.stringify(msg));

        // ✅ NEW: init (lang + i18n + payload)
        if (msg?.type === "init") {
          if (mergeI18n(msg.i18n)) log("✅ i18n merged from Sciter");
          if (msg.lang) state.lang = msg.lang;
          if (msg.payload) state.payload = { ...state.payload, ...msg.payload };
          render();
          return;
        }

        // ✅ NEW: i18n only update
        if (msg?.type === "setI18n") {
          if (mergeI18n(msg.i18n)) {
            log("✅ i18n updated from Sciter");
            render();
          }
          return;
        }

        if (msg?.type === "setLang") {
          state.lang = msg.lang;
          render();
          return;
        }

        if (msg?.type === "update") {
          applyPayload(msg.payload);
          return;
        }
      };
    </script>
  </body>
</html>
