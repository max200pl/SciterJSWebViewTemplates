<html
  window-frame="solid"
  window-resizable="false"
  window-width="max-content"
  window-height="max-content"
>
  <head>
    <title>Sciter WebView Bridge Test</title>
    <meta charset="utf-8" />
    <style>
      html {
        width: *;
        height: *;
        overflow-x: hidden;
        overflow-y: hidden;
        background: transparent;
      }

      body {
        position: relative;
        margin: 0;
        border: none;
      }

      main div {
        box-sizing: border-box;
      }

      main {
        width: *;
        height: 100%%;
      }

      webview {
        position: relative;
        display: block;
        size: *;
        background: transparent !important;
        behavior: webview library(sciter-webview);
      }

      .panel {
        left: 0;
        gap: 8dip;
        background: #ffffffcc;
        padding: 8dip;
        border-radius: 6dip;
      }

      button {
        padding: 6dip 10dip;
      }
    </style>

    <script type="module">
      import { templateHtml } from "./Templates.js";

      document.on("ready", () => {
        const elemWebView = document.$("webview");

        // ===== Helper: Sciter -> WebView =====
        function sendToTemplate(msg) {
          const js = `window.__fromSciter(${JSON.stringify(msg)})`;
          console.log("‚û°Ô∏è to template:", msg);
          elemWebView.webview.evaluateJavaScript(js);
        }

        // ===== Bridge: WebView -> Sciter =====
        elemWebView.jsBridgeCall = (params) => {
          try {
            const method = params?.[0];
            const payload = params?.[1];

            console.log("‚¨ÖÔ∏è jsBridgeCall:", method, payload);

            switch (method) {
              case "template:onReady":
                console.log("template ready:", payload);

                // ‚úÖ initial command to WebView (includes i18n + lang + payload)
                setTimeout(() => {
                  sendToTemplate({
                    type: "init",
                    lang: "en",
                    i18n: {
                      en: {
                        title: "Program removed: {programName}",
                        subtitle: "Leftover files: {count}",
                        counter: "Live counter",
                        switch: "Switch language",
                      },
                      uk: {
                        title: "–ü—Ä–æ–≥—Ä–∞–º—É –≤–∏–¥–∞–ª–µ–Ω–æ: {programName}",
                        subtitle: "–ó–∞–ª–∏—à–∫–æ–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤: {count}",
                        counter: "–õ—ñ—á–∏–ª—å–Ω–∏–∫",
                        switch: "–ó–º—ñ–Ω–∏—Ç–∏ –º–æ–≤—É",
                      },
                      ru: {
                        title: "–ü—Ä–æ–≥—Ä–∞–º–º–∞ —É–¥–∞–ª–µ–Ω–∞: {programName}",
                        subtitle: "–û—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {count}",
                        counter: "–°—á—ë—Ç—á–∏–∫",
                        switch: "–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫",
                      },
                    },
                    payload: {
                      programName: "WinZip",
                      count: 12,
                    },
                  });
                }, 0);

                return JSON.stringify({ ok: true });

              case "template:onAction":
                if (payload?.action === "close_webview") {
                  Window.this.close();
                  return JSON.stringify({ ok: true });
                }

                if (payload?.action === "cta_click") {
                  console.log("CTA clicked from template:", payload);
                  return JSON.stringify({ ok: true });
                }

                return JSON.stringify({ ok: true });

              case "template:onSize": {
                // payload: { width, height } from WebView template (.card)
                console.log("template size:", payload);

                const dimension = Window.this.screenBox(
                  "workarea",
                  "dimension",
                  true,
                );
                const [screenW, screenH] = dimension;

                // –ü—Ä–∏—à–µ–¥—à–∏–µ —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–æ—á–∫–∏ (px). –î–µ–ª–∞–µ–º safety.
                let w = Math.max(200, Number(payload?.width) || 0);
                let h = Math.max(120, Number(payload?.height) || 0);

                // ===== offsets / margins (–ø–æ–¥–≥–æ–Ω–∏ –ø–æ–¥ —Å–µ–±—è) =====
                const margin = 0; // –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è workarea
                const framePad = 0; // –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–º–∫—É/—Ç–µ–Ω—å/–ø–∞–¥–¥–∏–Ω–≥–∏ –æ–∫–Ω–∞
                w = w + framePad;
                h = h + framePad;

                // bottom-right positioning
                let x = screenW - w - margin;
                let y = screenH - h - margin;

                // clamp (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –±–æ–ª—å—à–µ —ç–∫—Ä–∞–Ω–∞)
                if (x < margin) x = margin;
                if (y < margin) y = margin;

                console.log(`move: x=${x} y=${y} w=${w} h=${h}`);

                Window.this.move(x, y, w, h);
                Window.this.state = Window.WINDOW_SHOWN;

                return JSON.stringify({ ok: true });
              }

              default:
                return JSON.stringify({
                  ok: false,
                  error: "Unknown method",
                  method,
                });
            }
          } catch (e) {
            return JSON.stringify({
              ok: false,
              error: String(e),
            });
          }
        };

        // ===== Load template =====
        elemWebView.on("webview-ready", () => {
          console.log("webview init success");
          elemWebView.webview.loadHtml(templateHtml);
        });

        elemWebView.on("webview-unavailable", () => {
          console.log("webview init failure");
        });

        // ===== UI buttons =====
        document.on("click", "#langEN", () =>
          sendToTemplate({ type: "setLang", lang: "en" }),
        );
        document.on("click", "#langUK", () =>
          sendToTemplate({ type: "setLang", lang: "uk" }),
        );
        document.on("click", "#langRU", () =>
          sendToTemplate({ type: "setLang", lang: "ru" }),
        );
        document.on("click", "#updatePayload", () =>
          sendToTemplate({
            type: "update",
            payload: {
              programName: "Adobe Reader",
              count: 27,
            },
          }),
        );
        document.on("click", "#updateI18n", () =>
        sendToTemplate({
            type: "setI18n",
            i18n: {
            ru: {
                title: "üöÄ RU from Sciter: {programName}",
                subtitle: "üßπ –û—Å—Ç–∞–ª–æ—Å—å —Ñ–∞–π–ª–æ–≤: {count}",
                counter: "–°—á—ë—Ç—á–∏–∫ (SCITER)",
                switch: "–°–º–µ–Ω–∏—Ç—å —è–∑—ã–∫",
            },
            en: {
                title: "üöÄ EN from Sciter: {programName}",
                subtitle: "üßπ Files left: {count}",
                counter: "Counter (SCITER)",
                switch: "Switch lang",
            },
            },
        }),
        );
      });
    </script>
  </head>

  <body>
    <webview></webview>

    <div class="panel">
        <button #langEN>EN</button>
        <button #langUK>UK</button>
        <button #langRU>RU</button>
        <button #updatePayload>Update payload</button>
        <button #updateI18n>Update i18n</button>
    </div>
    </div>
  </body>
</html>
