<html
  window-frame="solid"
  window-resizable="false"
  window-width="850dip"
  window-height="630dip"
>
  <head>
    <title>Sciter WebView Bridge Test</title>

    <style>
      html {
        width: *;
        height: *;
        overflow-x: hidden;
        overflow-y: hidden;

        background: transparent;
      }

      body {
        position: relative;
        margin: 0;
        border: none;
      }

      main div {
        box-sizing: border-box;
      }

      main {
        width: *;
        height: 100%%;
      }

      webview {
        position: relative;
        display: block;
        size: *;
        background: transparent !important;
        behavior: webview library(sciter-webview);
      }

      .panel {
        left: 0;
        display: flex;
        gap: 8dip;
        background: #ffffffcc;
        padding: 8dip;
        border-radius: 6dip;
      }

      button {
        padding: 6dip 10dip;
      }
    </style>

    <script type="module">
      import { templateHtml } from "./Templates.js";

      document.on("ready", () => {
        const elemWebView = document.$("webview");

        // ===== Bridge: WebView -> Sciter =====
        elemWebView.jsBridgeCall = (params) => {
          try {
            const method = params?.[0];
            const payload = params?.[1];

            console.log("⬅️ jsBridgeCall:", method, payload);

            switch (method) {
              case "template:onReady":
                console.log("template ready:", payload);

                // example: initial command to WebView
                setTimeout(() => {
                  sendToTemplate({
                    type: "update",
                    payload: {
                      programName: "WinZip",
                      count: 12,
                    },
                  });
                }, 1000);

                return JSON.stringify({ ok: true });

              case "template:onAction":
                if (payload?.action === "close_webview") {
                  Window.this.close();
                  return JSON.stringify({ ok: true });
                }

                if (payload?.action === "cta_click") {
                  console.log("CTA clicked from template:", payload);
                  return JSON.stringify({ ok: true });
                }

                return JSON.stringify({ ok: true });

              case "template:onSize": {
                // payload: { width, height } from WebView template (.card)
                console.log("template size:", payload);

                const dimension = Window.this.screenBox(
                  "workarea",
                  "dimension",
                  true,
                );
                const [screenW, screenH] = dimension;

                // Пришедшие размеры карточки (px). Делаем safety.
                let w = Math.max(200, Number(payload?.width) || 0);
                let h = Math.max(120, Number(payload?.height) || 0);

                // ===== offsets / margins (подгони под себя) =====
                const margin = 0; // отступ от края workarea
                const framePad = 0; // если нужно добавить рамку/тень/паддинги окна
                w = w + framePad;
                h = h + framePad;

                // bottom-right positioning
                let x = screenW - w - margin;
                let y = screenH - h - margin;

                // clamp (на случай если контент больше экрана)
                if (x < margin) x = margin;
                if (y < margin) y = margin;

                console.log(`move: x=${x} y=${y} w=${w} h=${h}`);

                Window.this.move(x, y, w, h);
                Window.this.state = Window.WINDOW_SHOWN;

                return JSON.stringify({ ok: true });
              }

              default:
                return JSON.stringify({
                  ok: false,
                  error: "Unknown method",
                  method,
                });
            }
          } catch (e) {
            return JSON.stringify({
              ok: false,
              error: String(e),
            });
          }
        };

        // ===== Load template =====
        elemWebView.on("webview-ready", () => {
          console.log("webview init success");
          elemWebView.webview.loadHtml(templateHtml);
        });

        elemWebView.on("webview-unavailable", () => {
          console.log("webview init failure");
        });

        // ===== Helper: Sciter -> WebView =====
        function sendToTemplate(msg) {
          const js = `window.__fromSciter(${JSON.stringify(msg)})`;
          console.log("➡️ to template:", msg);
          elemWebView.webview.evaluateJavaScript(js);
        }

        // ===== UI buttons =====
        document.on("click", "#langEN", () =>
          sendToTemplate({ type: "setLang", lang: "en" }),
        );
        document.on("click", "#langUK", () =>
          sendToTemplate({ type: "setLang", lang: "uk" }),
        );
        document.on("click", "#langRU", () =>
          sendToTemplate({ type: "setLang", lang: "ru" }),
        );

        document.on("click", "#updatePayload", () =>
          sendToTemplate({
            type: "update",
            payload: {
              programName: "Adobe Reader",
              count: 27,
            },
          }),
        );
      });
    </script>
  </head>

  <body>
    <webview></webview>

    <!-- ===== Debug control panel ===== -->
    <div class="panel">
      <button #langEN>EN</button>
      <button #langUK>UK</button>
      <button #langRU>RU</button>
      <button #updatePayload>Update payload</button>
    </div>
  </body>
</html>
